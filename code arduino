// =====================================================================
// ESP32: Relay + Servo + Firebase (REST API) – NO LCD VERSION
// =====================================================================

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <ESP32Servo.h>

// ====== CONFIG ======
const char* WIFI_SSID     = "Khoi Nguyen";
const char* WIFI_PASSWORD = "abcde12345";

String FIREBASE_URL = "https://minhquang-36ee2-default-rtdb.firebaseio.com";
String LOCKER_PATH = "/Locker1";

// ====== I/O ======
const int RELAY_PIN = 5;
const int SERVO_PIN = 4;
const bool ACTIVE_LOW = false;

// ====== Servo ======
Servo myServo;

// ====== State ======
bool relayState = false;
int servoPos = 0;

// ====== Auto-close ======
bool lockerIsOpen = false;
unsigned long openTime = 0;
const unsigned long AUTO_CLOSE_DELAY = 60000;   // 60s

// =====================================================================
// Firebase REST GET
// =====================================================================
String firebaseGet(String path) {
  HTTPClient http;
  String url = FIREBASE_URL + path + ".json";

  http.begin(url);
  int httpCode = http.GET();

  if (httpCode != 200) {
    http.end();
    return "";
  }

  String payload = http.getString();
  http.end();
  return payload;
}

// =====================================================================
// Firebase REST SET (PUT)
// =====================================================================
void firebaseSet(String path, String value) {
  HTTPClient http;
  String url = FIREBASE_URL + path + ".json";

  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  http.PUT(value);
  http.end();
}

// =====================================================================
// Device Control
// =====================================================================
void setRelay(bool on) {
  if (ACTIVE_LOW)
    digitalWrite(RELAY_PIN, on ? LOW : HIGH);
  else
    digitalWrite(RELAY_PIN, on ? HIGH : LOW);

  relayState = on;
}

void doOpen() {
  setRelay(true);
  delay(1000);
  myServo.write(90);
  servoPos = 90;

  lockerIsOpen = true;           // đánh dấu là đang mở
  openTime = millis();           // bắt đầu đếm thời gian mở
}

void doClose() {
  myServo.write(0);
  servoPos = 0;
  delay(1000);
  setRelay(false);

  lockerIsOpen = false;
}

// =====================================================================
// SETUP
// =====================================================================
void setup() {
  Serial.begin(115200);

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(400);
  }
  Serial.println("\nWiFi connected!");

  pinMode(RELAY_PIN, OUTPUT);
  if (ACTIVE_LOW) digitalWrite(RELAY_PIN, HIGH);
  else digitalWrite(RELAY_PIN, LOW);

  myServo.setPeriodHertz(50);
  myServo.attach(SERVO_PIN, 500, 2500);
  myServo.write(0);

  Serial.println("System ready.");
}

// =====================================================================
// LOOP
// =====================================================================
unsigned long lastPoll = 0;

void loop() {

  // 1) AUTO-CLOSE CHECK (chạy mỗi vòng loop)
  if (lockerIsOpen) {
    if (millis() - openTime >= AUTO_CLOSE_DELAY) {
      Serial.println("AUTO CLOSE triggered (1 minute passed).");

      doClose();

      // cập nhật Firebase
      firebaseSet(LOCKER_PATH + "/status", "\"close\"");
      firebaseSet(LOCKER_PATH + "/command", "\"auto_closed\"");
    }
  }

  // 2) POLL FIREBASE mỗi 1 giây
  if (millis() - lastPoll >= 1000) {
    lastPoll = millis();

    String cmdRaw = firebaseGet(LOCKER_PATH + "/status");
    if (cmdRaw.length() == 0) return;

    cmdRaw.trim();
    cmdRaw.replace("\"", "");

    Serial.print("Status = ");
    Serial.println(cmdRaw);

    if (cmdRaw == "open") {
      doOpen();
      firebaseSet(LOCKER_PATH + "/status", "\"idle\"");
      firebaseSet(LOCKER_PATH + "/command", "\"done\"");
    }

    if (cmdRaw == "close") {
      doClose();
      firebaseSet(LOCKER_PATH + "/status", "\"idle\"");
      firebaseSet(LOCKER_PATH + "/command", "\"done\"");
    }
  }
}
